!function(){"use strict";function t(t,e=document){return e.querySelector(t)}function e(e){function n(){const t=g.getBoundingClientRect(),e=window.devicePixelRatio||1;f.style.width=t.width+"px",f.style.height=t.height+"px";const n=Math.max(1,Math.round(t.width*e)),a=Math.max(1,Math.round(t.height*e));f.width===n&&f.height===a||(f.width=n,f.height=a),v.setTransform(e,0,0,e,0,0)}function a(){function t(t,e,n,a,s){const o=t*j,r=H[o+n*A+e],l=H[o+n*A+a],i=H[o+s*A+e];return H[o+s*A+a]-l-i+r}z=!1,n();const e=g.getBoundingClientRect(),a=e.width,s=e.height;v.clearRect(0,0,a,s);const o=Math.max(2,0|W),r=Math.ceil(a/o),l=Math.ceil(s/o),i=function(){const t=y?y.querySelector('input[name="apt-num-scales"]:checked'):null,e=parseInt(t&&t.value?t.value:"2",10);return Math.max(2,Math.min(4,e))}(),u=Array.from({length:i},function(t,e){return o*Math.pow(2,e)}),c=u.map(function(t){return{ps:t,cols:Math.ceil(a/t),rows:Math.ceil(s/t)}}),h=document.getElementById("apt-threshold-size-s2"),d=document.getElementById("apt-threshold-size-s3"),m=document.getElementById("apt-threshold-size-s4");h&&i>=2&&(h.textContent=u[i-1]+" px"),d&&i>=3&&(d.textContent=u[i-2]+" px"),m&&i>=4&&(m.textContent=u[i-3]+" px");const p=document.createElement("canvas");p.width=Math.max(1,Math.round(a)),p.height=Math.max(1,Math.round(s));const f=p.getContext("2d");f.drawImage(g,0,0,p.width,p.height);const M=f.getImageData(0,0,p.width,p.height).data,x=p.width,w=p.height,S=512,B=Math.log2(S),F=new Uint8Array(x*w);for(let t=0,e=0;t<M.length;t+=4,e++){let n=.5*(.2989*(M[t]/127.5-1)+.587*(M[t+1]/127.5-1)+.114*(M[t+2]/127.5-1)+1);n<0?n=0:n>1&&(n=1);const a=Math.min(S-1,n*S|0);F[e]=a}let C=S<=128,A=0,j=0,H=null;if(C){A=x+1,j=(w+1)*(x+1),H=new Uint32Array(S*j);for(let t=0;t<w;t++){const e=t*x,n=new Uint32Array(S);for(let a=0;a<x;a++){n[F[e+a]]++;const s=(t+1)*A+(a+1),o=t*A+(a+1);for(let t=0,e=0;t<S;t++,e+=j)H[e+s]=H[e+o]+n[t]}}}const q=c.map(function({rows:t,cols:e}){return new Float32Array(t*e)});if(C)for(let e=0;e<c.length;e++){const{rows:n,cols:a}=c[e],s=q[e];for(let o=0;o<n;o++)for(let n=0;n<a;n++){const r=n*c[e].ps,l=o*c[e].ps,i=Math.min(r+c[e].ps,x),u=Math.min(l+c[e].ps,w),h=(i-r)*(u-l)||1;let d=0;for(let e=0;e<S;e++){const n=t(e,r,l,i,u);if(n){const t=n/h;d-=t*Math.log2(t)}}s[o*a+n]=d}}else for(let t=0;t<c.length;t++){const{rows:e,cols:n}=c[t],a=q[t];for(let s=0;s<e;s++)for(let e=0;e<n;e++){const o=new Uint16Array(S),r=e*c[t].ps,l=s*c[t].ps,i=Math.min(r+c[t].ps,x),u=Math.min(l+c[t].ps,w),h=(i-r)*(u-l)||1;for(let t=l;t<u;t++){const e=t*x+r;for(let t=r;t<i;t++)o[F[e+(t-r)]]++}let d=0;for(let t=0;t<S;t++){const e=o[t];if(e){const t=e/h;d-=t*Math.log2(t)}}a[s*n+e]=d}}const R=[];i>=2&&R.push(Math.min(B,Math.max(0,parseFloat(E.s2&&E.s2.value?E.s2.value:"5.0")))),i>=3&&R.push(Math.min(B,Math.max(0,parseFloat(E.s3&&E.s3.value?E.s3.value:"5.0")))),i>=4&&R.push(Math.min(B,Math.max(0,parseFloat(E.s4&&E.s4.value?E.s4.value:"5.0")))),I.s2&&E.s2&&(I.s2.textContent=parseFloat(E.s2.value).toFixed(1)),I.s3&&E.s3&&(I.s3.textContent=parseFloat(E.s3.value).toFixed(1)),I.s4&&E.s4&&(I.s4.textContent=parseFloat(E.s4.value).toFixed(1));const U=c.map(function({rows:t,cols:e}){return new Uint8Array(t*e)});U[0].fill(1);for(let t=i-1;t>=1;t--){const{rows:e,cols:n}=c[t],a=q[t];var _=R[i-1-t];const s=_===undefined||null===_?B:_,o=U[t];for(let t=0;t<e;t++)for(let e=0;e<n;e++)o[t*n+e]=a[t*n+e]<s?1:0}for(let t=i-1;t>=1;t--){const{ps:e,rows:n,cols:a}=c[t];for(let s=t-1;s>=0;s--){const{ps:o,rows:r,cols:l}=c[s],i=Math.max(1,Math.floor(e/o));for(let e=0;e<n;e++)for(let n=0;n<a;n++){if(!U[t][e*a+n])continue;const o=e*i,u=n*i,c=Math.min(r,o+i),h=Math.min(l,u+i);for(let t=o;t<c;t++)for(let e=u;e<h;e++)U[s][t*l+e]=0}}}v.lineWidth=.75,v.strokeStyle="rgba(255,255,255,0.9)";for(let t=i-1;t>=0;t--){const{ps:e,rows:n,cols:o}=c[t],r=U[t];for(let t=0;t<n;t++)for(let n=0;n<o;n++){if(!r[t*o+n])continue;const l=n*e+.5,i=t*e+.5,u=Math.min(e,a-n*e)-1,c=Math.min(e,s-t*e)-1;u>0&&c>0&&v.strokeRect(l,i,Math.floor(u),Math.floor(c))}}if(v.strokeStyle="rgba(255,255,255,0.95)",v.strokeRect(.5,.5,Math.floor(a)-1,Math.floor(s)-1),b&&(b.textContent=Math.round(a)+"\xd7"+Math.round(s)),k){const t=r*l;k.textContent=t+" tokens ("+r+"\xd7"+l+")"}if(L){let t=0;for(let e=0;e<i;e++){const{rows:n,cols:a}=c[e],s=U[e];let o=0;for(let t=0;t<s.length;t++)o+=s[t];t+=o}const e=r*l,n=e>0?Math.max(0,1-t/e):0,a=Math.round(100*n);L.innerHTML=t+' tokens <span class="apt-green">-'+a+"%</span>"}}function s(){z||(z=!0,requestAnimationFrame(a))}function o(t){M&&M.value!==String(t)&&(M.value=String(t)),x&&x.value!==String(t)&&(x.value=String(t))}function r(t){if(!isFinite(t))return 16;const e=Math.max(8,Math.min(128,t));return 8*Math.round(e/8)}function l(t){const e=r(parseInt(t.target.value,10));if(o(W=e),F){F.step=String(W);const t=c(parseInt(F.value||"512",10),W);String(t)!==F.value&&(F.value=String(t))}m(),s()}function i(){const t=y?y.querySelector('input[name="apt-num-scales"]:checked'):null,e=Math.max(2,Math.min(4,parseInt(t&&t.value?t.value:"2",10)));w.s2&&(w.s2.style.display=e>=2?"":"none"),w.s3&&(w.s3.style.display=e>=3?"":"none"),w.s4&&(w.s4.style.display=e>=4?"":"none")}function u(){s()}function c(t,e){if(!isFinite(t))return 512;const n=224,a=1024,s=Math.max(1,0|e),o=Math.max(n,Math.min(a,t));return Math.round(o/s)*s}function h(t,e){if(!isFinite(t))return 512;const n=224,a=1024,s=Math.max(1,0|e),o=Math.max(n,Math.min(a,t));return Math.floor(o/s)*s}function d(){if(!F)return;const t=g.naturalWidth&&g.naturalHeight?Math.min(g.naturalWidth,g.naturalHeight):1024,e=Math.max(224,h(t,W));F.max=String(e);const n=parseInt(F.value||String(e),10);let a=Math.min(e,n);a=c(a,W),String(a)!==F.value&&(F.value=String(a)),C&&(C.textContent=a+" px")}function m(){const t=c(F?parseInt(F.value,10):NaN,W);if(C&&(C.textContent=t+" px"),g.naturalWidth&&g.naturalHeight){const e=g.naturalWidth,n=g.naturalHeight,a=t/Math.min(e,n),s=Math.max(1,Math.round(e*a));g.style.width=s+"px",g.style.height="auto"}}function p(t){j=(t%A.length+A.length)%A.length;const e=A[j];g.getAttribute("src")!==e?g.setAttribute("src",e):s()}const g=t(".apt-img",e),f=t(".apt-grid-canvas",e),v=f.getContext("2d"),M=document.getElementById("apt-base-size-range"),x=document.getElementById("apt-base-size-number"),y=document.getElementById("apt-num-scales-group"),w={s2:document.getElementById("apt-threshold-row-s2"),s3:document.getElementById("apt-threshold-row-s3"),s4:document.getElementById("apt-threshold-row-s4")},E={s2:document.getElementById("apt-threshold-range-s2"),s3:document.getElementById("apt-threshold-range-s3"),s4:document.getElementById("apt-threshold-range-s4")},I={s2:document.getElementById("apt-threshold-value-s2"),s3:document.getElementById("apt-threshold-value-s3"),s4:document.getElementById("apt-threshold-value-s4")},S=e.querySelector(".apt-nav-prev"),B=e.querySelector(".apt-nav-next"),F=document.getElementById("apt-short-side-range"),C=document.getElementById("apt-short-side-value"),b=document.getElementById("apt-stats-size"),k=document.getElementById("apt-stats-tokens"),L=document.getElementById("apt-stats-apt-tokens"),A=["/assets/apt-imgs/golden_gate3.jpg","/assets/apt-imgs/joshua_tree.jpg","/assets/apt-imgs/lost_coast.jpg","/assets/apt-imgs/mojave.jpg","/assets/apt-imgs/palace.jpg","/assets/apt-imgs/death_valley.jpg","/assets/apt-imgs/blackboard.jpg","/assets/apt-imgs/apt.jpg"];let j=0;try{const t=g.getAttribute("src")||"",e=A.findIndex(function(e){return t.endsWith(e)});e>=0&&(j=e)}catch(U){}A.forEach(function(t){(new Image).src=t});let W=(H=M&&M.value?M.value:x&&x.value?x.value:"16",parseInt(H,10));var H;let z=!1;M&&M.addEventListener("input",l),x&&x.addEventListener("input",l),E.s2&&E.s2.addEventListener("input",u),E.s3&&E.s3.addEventListener("input",u),E.s4&&E.s4.addEventListener("input",u),y&&y.addEventListener("change",function(){i(),s()});const q=new ResizeObserver(function(){s()});q.observe(g),q.observe(e);const R=function(){if(F&&g.naturalWidth&&g.naturalHeight){const t=Math.min(g.naturalWidth,g.naturalHeight);d();const e=c(t,W);F.value=String(e)}m(),s()};if(g.addEventListener("load",R),g.complete&&s(),S&&S.addEventListener("click",function(){p(j-1)}),B&&B.addEventListener("click",function(){p(j+1)}),F&&F.addEventListener("input",function(){if(F){const t=c(parseInt(F.value,10),W);String(t)!==F.value&&(F.value=String(t))}m(),s()}),o(W=r(W)),F&&(F.step=String(W)),d(),F&&g.naturalWidth&&g.naturalHeight){const t=c(Math.min(g.naturalWidth,g.naturalHeight),W);F.value=String(t)}return C&&F&&(C.textContent=c(parseInt(F.value||"512",10),W)+" px"),i(),I.s2&&E.s2&&(I.s2.textContent=parseFloat(E.s2.value||"5.0").toFixed(1)),I.s3&&E.s3&&(I.s3.textContent=parseFloat(E.s3.value||"5.0").toFixed(1)),I.s4&&E.s4&&(I.s4.textContent=parseFloat(E.s4.value||"5.0").toFixed(1)),s(),{setBasePatchSize(t){if(o(W=Math.max(2,0|t)),F&&(F.step=String(W)),F){const t=c(parseInt(F.value||"512",10),W);F.value=String(t),d()}m(),s()}}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".apt-grid-demo").forEach(e)})}();